<!DOCTYPE html>
<html>

<head>
  
  <title>Emotional Map</title>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  
  <style>

    html, body {
      margin: 0;
      padding-left: 20px;
      padding-right: 20px;
      height: 100%;
      font-family: Arial, sans-serif;
      background: #0d142b;
      color: #e0e6f0;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
    }

    h1 {
      margin: 0;
      padding: 20px;
    }

    #mainSection {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      /*overflow: hidden; /* pour √©viter les scrolls inutiles */
    }

    .auth-section, .info, .status {
      margin-bottom: 20px;
      background: #e8f4fd;
      border-radius: 8px;
      padding: 15px;
    }

    .chart-container {
      flex-grow: 1;
      overflow: hidden;
      border-radius: 12px;
      margin-bottom: 20px;
      min-height: 0;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      flex-shrink: 0; 
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
    }


    .btn-primary { background: #3e7552; color: white; }
    .btn-success { background: #5b232f; color: white; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }

  </style>


</head>

 
<body>
  <div class="container">
    
    <div class="header-bar">
      <h1>ü´Ä Emotional Map</h1>
      
      <div id="logoutButton" style="display: none;">
        <button class="btn-success" onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Section d'authentification -->
    <div id="authSection" style="display:{{authSectionDisplay}};">

      <h3>Authentification</h3>
      <div class="info">
        <strong>Configuration:</strong> {{numSeats}} Valid ids from 1 to {{numSeats}}
      </div>

      <input type="text" id="userIdInput" placeholder="Id (1 to {{numSeats}})" />
      <button class="btn-primary" onclick="authenticateUser()">Login</button>
      <div id="authStatus"></div>

    </div> 

    <!-- Section principale -->
    <div id="mainSection" style="display:{{mainSectionDisplay}};">

      <div class="chart-container">
        <canvas id="bpmChart"></canvas>
      </div>

    </div>
  </div>

  <script>
    let chart = null;
    let currentUser = '{{autoAuth}}' === 'true' ? '{{userId}}' : null;

    const validUsers = [{{validUsersString}}];
    const autoAuth = '{{autoAuth}}' === 'true';
    const presetUserId = '{{userId}}';

    // Automatic authentification when authentication via link
    window.onload = function() {
      if (autoAuth && presetUserId) {
        authenticateUserAuto(presetUserId);
      }
    };

    function authenticateUserAuto(userId) {
      fetch(`/api/auth/${userId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            currentUser = userId;
            showMainSection();
            loadBpmData(userId);
          } else {
            console.error('√âchec authentification automatique');
          }
        })
        .catch(error => {
          console.error('Erreur authentification automatique:', error);
        });
    }

    function authenticateUser() {

      let userId = document.getElementById('userIdInput').value.trim();
      const statusDiv = document.getElementById('authStatus');

      if (!validUsers.includes(userId)) {
        statusDiv.innerHTML = '<div class="status error">‚ùå Invalid id. Valid ids within 1 and {{numSeats}}.</div>';
        return;
      }

      fetch(`/api/auth/${userId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            statusDiv.innerHTML = `<div class="status success">‚úÖ Authentifi√©: ${data.profile}</div>`;
            currentUser = userId;
            showMainSection();
            loadBpmData(userId);
          } else {
            statusDiv.innerHTML = '<div class="status error">‚ùå √âchec authentification</div>';
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          statusDiv.innerHTML = '<div class="status error">‚ùå Erreur r√©seau</div>';
        });
    }

    function showMainSection() {
      document.getElementById('authSection').style.display = 'none';
      document.getElementById('mainSection').style.display = 'block';
      document.getElementById('logoutButton').style.display = 'block';
    }

    function logout() {
      // Reset values
      currentUser = null;
      if(chart) {
        chart.destroy();
        chart = null;
      }
      document.getElementById('authStatus').innerHTML = '';
      document.getElementById('userIdInput').value = '';
      document.getElementById('logoutButton').style.display = 'none';

      // Redirect toward authentication page
      window.location.href = '/';
    }

    function loadBpmData(userId) {
      fetch(`/api/bpm/${userId}`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            updateChart(data.bpmData, data.time, data.profile, data.avg, data.avgTime);
          }
        })
        .catch(error => console.error('Erreur BPM:', error));
    }

    function updateChart(bpmData, time, profileName, avgBpm, avgTime) {

      // Convert timestamps in relative time with format hour:min
      const startTime = time[0];
      const labels = time.map(timestamp => {
        const elapsedSeconds = (timestamp - startTime)/1000;
        const hours = Math.floor(elapsedSeconds / 3600);
        const minutes = Math.floor((elapsedSeconds % 3600) / 60);
      
        return hours + ':' + minutes.toString().padStart(2, '0');
      });
      
      // Define y bounds
      const allBpmValues = [...bpmData, ...avgBpm].filter(val => val !== null);
      const minBpm = Math.min(...allBpmValues);
      const maxBpm = Math.max(...allBpmValues);

      const yMinBound = Math.floor( (minBpm - (maxBpm-minBpm)*0.2) / 10 ) * 10;  
      const yMaxBound = Math.ceil( (maxBpm + (maxBpm-minBpm)*0.2) / 10 ) * 10; 

      // Define datasets
      const datasets = [
        {
          label: 'Seat ' + profileName,
          data: bpmData,
          borderColor: '#36A2EB',
          borderWidth: 2,
          radius: 0,
          tension: 0.2,
          pointHoverRadius: 5
        },
        {
          label: 'Audience average',
          data: avgBpm,
          borderColor: '#dd7768',
          borderWidth: 2,
          radius: 0,
          tension: 0.2,
          pointHoverRadius: 5
        }
      ];
      
      // Make sure no chart is already here
      if (chart) {
          chart.destroy();
      }

      // Define animation
      const totalDuration = 5000;
      const delayBetweenPoints = totalDuration / bpmData.length;
      const previousY = (ctx) => ctx.index === 0 ? ctx.chart.scales.y.getPixelForValue(100) : ctx.chart.getDatasetMeta(ctx.datasetIndex). data[ctx.index - 1].getProps(['y'], true).y;
      const animation = {
        x: {
          type: 'number',
          easing: 'linear',
          duration: delayBetweenPoints,
          from: NaN, // the point is initially skipped
          delay(ctx) {
            if (ctx.type !== 'data' || ctx.xStarted) {
              return 0;
            }
            ctx.xStarted = true;
            return ctx.index * delayBetweenPoints;
          }
        },
        y: {
          type: 'number',
          easing: 'linear',
          duration: delayBetweenPoints,
          from: previousY,
          delay(ctx) {
            if (ctx.type !== 'data' || ctx.yStarted) {
              return 0;
            }
            ctx.yStarted = true;
            return ctx.index * delayBetweenPoints;
          }
        }
      };

      // Create chart
      chart = new Chart(document.getElementById('bpmChart').getContext('2d'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: datasets
        },
        options: {
          animation,
          responsive: true,
          plugins: {
            legend: {
              labels: {
                color: '#737fa9',
                font: {
                  size: 15
                },
                padding: 20
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              min: yMinBound,
              max: yMaxBound,
              title: {
                display: true,
                text: 'BPM',
                color: '#737fa9',
                font: {
                  size: 17
                }
              },
              ticks: {
                color: '#737fa9',
                font: {
                  size: 15
                }
              },
              grid: {
                color: '#232734'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Elapsed time (h:min)',
                color: '#737fa9',
                font: {
                  size: 17
                }
              },
              ticks: {
                maxTicksLimit: 10, // Label nb limit
                maxRotation: 45,   // Rotation des labels si n√©cessaire
                minRotation: 0,
                color: '#737fa9',
                font: {
                  size: 15
                }
              },
              grid: {
                color: '#232734'
              }
            }
          }
        }
      });
    }

  </script>

</body>
</html>